<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Nightmare</title>
        <!-- Redirect script at the very top to catch any attempts to leave -->
        <script>
            // Cookie functions
            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
                const expires = "expires=" + d.toUTCString();
                document.cookie =
                    name + "=" + value + ";" + expires + ";path=/";
            }

            function getCookie(name) {
                const cname = name + "=";
                const decodedCookie = decodeURIComponent(document.cookie);
                const ca = decodedCookie.split(";");
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === " ") {
                        c = c.substring(1);
                    }
                    if (c.indexOf(cname) === 0) {
                        return c.substring(cname.length, c.length);
                    }
                }
                return "";
            }

            function deleteCookie(name) {
                document.cookie =
                    name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            }

            // Trap the user in nightmare
            setCookie("nightmareTrapped", "true", 1); // Set for 1 day

            // Check if user has escaped
            const hasEscaped = getCookie("nightmareEscaped") === "true";

            // Intercept navigation attempts if user hasn't escaped
            if (!hasEscaped) {
                // Override history navigation
                history.pushState(null, document.title, location.href);
                window.addEventListener("popstate", function () {
                    history.pushState(null, document.title, location.href);
                    showNightmareWhisper("you can't escape...");
                });

                // Add event listener to detect when document becomes visible again
                document.addEventListener("visibilitychange", function () {
                    if (!document.hidden && !hasEscaped) {
                        showNightmareWhisper("still trapped...");
                    }
                });

                // Function to show nightmare whisper when escape attempts happen
                function showNightmareWhisper(text) {
                    const whisper = document.createElement("div");
                    whisper.className = "whisper";
                    whisper.style.left = Math.random() * 80 + 10 + "%";
                    whisper.style.top = Math.random() * 80 + 10 + "%";
                    whisper.style.opacity = "0.6";
                    whisper.textContent = text;

                    document.getElementById("whispers").appendChild(whisper);

                    setTimeout(() => {
                        whisper.style.opacity = "0";
                        setTimeout(() => {
                            whisper.remove();
                        }, 500);
                    }, 2000);
                }
            }
        </script>
        <link
            href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                font-family: "EB Garamond", serif;
                color: #8f8f8f;
                background-color: #000;
                height: 100%;
                overflow: hidden;
                cursor:
                    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="6" fill="%23000000" stroke="%23ffffff" stroke-width="1"/></svg>')
                        8 8,
                    auto;
            }

            @keyframes breathe {
                0% {
                    background-color: #000000;
                }
                50% {
                    background-color: #050505;
                }
                100% {
                    background-color: #000000;
                }
            }

            @keyframes textDistort {
                0% {
                    filter: blur(0);
                    transform: skewX(0);
                }
                25% {
                    filter: blur(4px);
                    transform: skewX(5deg);
                }
                75% {
                    filter: blur(2px);
                    transform: skewX(-5deg);
                }
                100% {
                    filter: blur(0);
                    transform: skewX(0);
                }
            }

            /* Glitch effect for text */
            @keyframes glitchEffect {
                0% {
                    opacity: 0.2;
                    transform: translate(-2px, 2px);
                }
                25% {
                    opacity: 0.5;
                    transform: translate(2px, -2px);
                    filter: hue-rotate(90deg);
                }
                50% {
                    opacity: 0.3;
                    transform: translate(-1px, -1px);
                    filter: hue-rotate(180deg);
                }
                75% {
                    opacity: 0.4;
                    transform: translate(1px, 1px);
                    filter: hue-rotate(270deg);
                }
                100% {
                    opacity: 0.2;
                    transform: translate(-2px, 2px);
                }
            }

            .whisper.glitch {
                animation: glitchEffect 0.3s infinite;
                color: rgba(255, 255, 255, 0.7);
                font-family: monospace;
                letter-spacing: -1px;
                text-shadow:
                    0 0 5px rgba(255, 0, 0, 0.5),
                    0 0 10px rgba(0, 0, 255, 0.3);
            }

            .container {
                position: relative;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 1rem;
                overflow: hidden;
            }

            #whispers {
                position: absolute;
                width: 100%;
                height: 100%;
                z-index: 1;
            }

            .whisper {
                position: absolute;
                color: rgba(255, 255, 255, 0.1);
                font-size: 1.2rem;
                opacity: 0;
                transition: opacity 0.4s ease-in;
            }

            #flash {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: white;
                opacity: 0;
                transition: opacity 0.1s ease;
                z-index: 100;
                pointer-events: none;
            }

            #flashText {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 3rem;
                color: #000;
                text-align: center;
                opacity: 0;
                z-index: 101;
                pointer-events: none;
            }

            #wakeUpBtn {
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%);
                z-index: 200;
                padding: 0.5rem 1rem;
                background-color: rgba(0, 0, 0, 0.8);
                color: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0);
                border-radius: 0.2rem;
                font-family: "EB Garamond", serif;
                font-size: 1rem;
                cursor: pointer;
                opacity: 0;
                transition:
                    opacity 0.3s ease,
                    background-color 0.3s ease;
            }

            .music-control {
                position: fixed;
                top: 20px;
                left: 20px;
                padding: 5px 10px;
                background-color: rgba(0, 0, 0, 0.8);
                color: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                font-size: 12px;
                opacity: 0; /* Completely invisible */
                pointer-events: none; /* Can't be clicked */
                display: none; /* Completely hide the element */
                z-index: -1; /* Behind everything */
            }

            .music-control:hover {
                opacity: 0; /* Still invisible even on hover */
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="whispers"></div>
            <div id="flash"></div>
            <div id="flashText"></div>

            <button id="wakeUpBtn">ESCAPE</button>

            <!-- Music control button -->
            <button id="musicControlBtn" class="music-control">
                Music: On
            </button>

            <!-- Background music (hidden) -->
            <audio
                id="backgroundMusic"
                loop
                preload="auto"
                style="display: none"
            >
                <source src="/audio/creepy-music-box.mp3" type="audio/mpeg" />
            </audio>

            <!-- Pink Noise (hidden) with even lower volume -->
            <audio
                id="pinkNoiseAudio"
                loop
                preload="auto"
                style="display: none"
            >
                <source src="/audio/pink-noise.mp3" type="audio/mpeg" />
            </audio>
        </div>

        <script>
            // Messages that can appear during flashes
            const flashMessages = [
                "WAKE UP",
                "IT'S JUST A DREAM",
                "YOU'RE NOT REAL",
                "THERE IS NO ESCAPE",
                "YOU'RE TRAPPED",
                "DON'T TRUST THEM",
                "THEY'RE WATCHING",
                "REMEMBER WHO YOU ARE",
                "THE DARKNESS CONSUMES",
                "YOU'VE BEEN HERE BEFORE",
                "YOU CANNOT LEAVE",
            ];

            // Whispers content
            const whisperTexts = [
                "help me",
                "it's cold here",
                "have you forgotten?",
                "we're still waiting",
                "come back to us",
                "remember the promise",
                "don't leave us again",
                "you abandoned us",
                "the fire is dying",
                "it's your fault",
                "we can see you",
                "behind you",
                "listen carefully",
                "you never escaped",
                "this isn't over",
                "do you hear it too?",
                "they're watching",
                "your shadow lied",
                "the door is open",
                "you were warned",
                "nothing is real",
                "i remember your face",
                "why did you run?",
                "closer... just a little closer",
                "we never stopped screaming",
                "you shouldn't have looked",
                "don't trust the light",
                "it breathes with you",
                "the silence is hungry",
                "we became the dark",
                "you are the last one",
                "time is breaking",
                "your name is fading",
                "this place remembers",
                "you are not alone… but you should be",
                "even the dead are afraid",
                "it's listening through you",
                "we still feel the fire",
                "your heartbeat lies",
                "we never died",
                "there is no way out",
                "we forgave you... once",
                "we are what's left",
                "open your eyes",
                "don't blink",
                "the sky is cracking",
                "it wants your name",
                "she never stopped crying",
                "they're not asleep",
                "you made us wait",
                "the walls are whispering too",
                "did you hear that?",
                "we were here first",
                "your skin remembers",
                "we know your thoughts",
                "stop pretending",
                "it sees through you",
                "your breath is not yours",
                "we're already inside",
                "the mirror lied",
                "you called us",
                "we never left",
                "we woke up for you",
                "you feel it crawling, don't you?",
                "you belong here now",
                "this isn't your dream",
                "we lost the way",
                "you forgot how it ends",
                "the ground is hollow",
                "you are repeating again",
                "shhh… it's almost here",
                "the stars are wrong",
                "you brought it with you",
                "where is your face?",
                "the cold remembers",
                "the whispers are growing",
                "you never had a choice",
                "don't listen to yourself",
                "it was always you",
                "something is missing",
                "you left it open",
                "we are all broken here",
                "your voice cracks too easily",
                "the silence is full of teeth",
                "you made it worse",
                "it's not over until you forget",
                "do you hear the scratching?",
                "it knows you're awake",
                "everything here is watching",
                "you forgot the ending",
                "something followed you",
                "they're inside the walls",
                "your dream is leaking",
                "we never wanted your help",
                "you left the door wide open",
                "it's waiting behind your eyes",
                "we loved you once",
                "it hates the light you carry",
                "you don't belong in this skin",
                "where did you bury us?",
                "the voices are multiplying",
                "your silence is too loud",
                "you let it in",
                "we miss the screaming",
                "you blinked too soon",
                "your hands aren't yours anymore",
                "you're becoming something else",
                "you keep waking up wrong",
                "it remembers your heartbeat",
                "don't close your eyes now",
                "you left a piece of you behind",
                "we were never human",
                "you dream in our language now",
                "the echoes are feeding",
                "you were warned—again and again",
                "your guilt stinks of fire",
                "you taste like regret",
                "we hear you breathing",
                "you are the crack in the mirror",
                "you promised us forever",
                "we whispered first",
                "it's learning your name",
                "don't let it answer",
                "you never came alone",
                "the floor is listening",
                "you opened it, now seal it",
                "we will finish what you started",
                "your reflection lied",
                "you'll never be clean again",
                "we remember the cold",
                "your dreams are infected",
                "you wrote this ending",
                "it's behind your thoughts",
                "we stitched your name into this place",
                "you walked into memory",
                "you made this real",
                "the air is thicker now",
                "you've been heard",
                "your silence gave it shape",
                "we're whispering through you",
                "it's almost your turn",
            ];

            // Menambahkan teks bisikan yang "glitch" - dengan karakter berantakan
            const glitchWhisperTexts = [
                "c̵̭͖̐́ͣo̝͚͞m̤͔e̴̛͚͂ ̗̌͌̀b̩̫̎͋a̮͚̪̐c̢̤͓̊ͧ͡k̻̠̑́͟",
                "ḫ̷ͫ͠e͎̋ͩ͒l̉̔̑͐p̧̟͌ͅ ̢̹̻ͅu̼̙͌̈͝s͕̈",
                "ḓ̨ͅǫ̢̪n̆̄ͅ'̶̘̅ͅt̶̥̖͈͑ ̢̟͖̿͐l̶̝̤̆̀ȯ͎̗o̢̻̟̔k̢̛̲͉̔",
                "y̶̬̆̿͂o̲̊͊͜͜u̶͎͐͞ ̸̱̦̱͛c̼̿̿͡a̛͙ͅn̴̛̠̩ͅ't̡̠̀ͅ ̰͓̍̕e̛̦̰͐́s̵̱̘̀͡c̔͢ͅa̭̙͇͊p̶̡̱̙̽e̲̙̎̑",
                "w̧̮̿͋̌e̠̊̎̄ ̰̳̩̑a̧̝̩ͅr̵̟̬ͅe̞͡͝ ̠̓͗͡w̧̛̜ͅa̡̪̪̓ͅt̺ͅc̢̠ͅh̨̙͕̓i̙̗̓ͅn̠̰ͅg̩̾͢ͅ",
                "̨͓̤͛͘h̴͕̫̻͗e̥͙̔ͬͅl̴͖̬̦̃p̹͚̩͘͟ ̟̓ͯ͒͝m̡̟̼̆ͨe͉̫͈ͮ̕",
                "̶̯̫̱ͤṅ̴͕̱̩̂o͕̝̙͗̕ ̶̵̨̯̒e̷̫̹̱͊s̡̩̰̮͂c̛̣̪͕͒ä̡̛̰͖́p̘̳ͮͨ͘e̻̥̜̅͜",
                "͓̭͂ͯ͞i̧̪̳̊͋t̤̥̜͆͡'̸̭͙ͩͬs̵̳̥ͣͤ ̓͏̻̥̥a͓̭̯͑͘l͎̱̭̆̕l̷̗̣̃́ ̫̰̋ͭ͞y̨͙͓̏̉ŏ̷̬̤̘ͧuͤ͏̣͕̙r̵̫̮̲̓ ̜̘͙̂͠f̙̪̘̉͠a̮̫͔̎͟u̴̻̻̓͠l͚̹̾ͬ͝t̞̪ͥ͑͜",
            ];

            // Maximum number of whispers at once - dikurangi untuk optimasi performa
            const MAX_WHISPERS = 100; // Jumlah lebih sedikit untuk mengurangi beban DOM

            // Variabel untuk melacak penggunaan audio
            let activeAudioCount = 0;
            const MAX_ACTIVE_AUDIO = 2; // Batasi maksimum pemutaran audio bersamaan

            // Main controller for audio caching and requests
            let audioCache = new Map();

            // Create random whispers
            function createWhispers() {
                const container = document.getElementById("whispers");

                // Clear any existing whispers for fresh start
                container.innerHTML = "";

                for (let i = 0; i < MAX_WHISPERS; i++) {
                    const whisper = document.createElement("div");
                    whisper.className = "whisper";

                    // Randomly decide if this will be a glitched text (20-30% chance)
                    const isGlitch = Math.random() < Math.random() * 0.1 + 0.2;

                    let text;
                    if (isGlitch) {
                        const glitchIndex = Math.floor(
                            Math.random() * glitchWhisperTexts.length,
                        );
                        text = glitchWhisperTexts[glitchIndex];
                        whisper.classList.add("glitch"); // Add glitch class for visual effect
                    } else {
                        const randomIndex = Math.floor(
                            Math.random() * whisperTexts.length,
                        );
                        text = whisperTexts[randomIndex];
                    }

                    whisper.textContent = text;
                    whisper.dataset.isGlitch = isGlitch;

                    // Random position
                    const randomX = Math.random() * 100;
                    const randomY = Math.random() * 100;

                    whisper.style.left = `${randomX}%`;
                    whisper.style.top = `${randomY}%`;
                    whisper.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;

                    container.appendChild(whisper);
                }
            }

            // Play audio for whisper text
            async function playWhisperAudio(text) {
                // Limit concurrent audio playback
                if (activeAudioCount >= MAX_ACTIVE_AUDIO) {
                    return;
                }

                try {
                    activeAudioCount++;

                    // Add more realistic voice settings for whispers
                    const stability = Math.random() * 0.2 + 0.3; // Lower stability (0.3-0.5) for more unstable sound
                    const similarity_boost = Math.random() * 0.3 + 0.7; // 0.7-1.0
                    const style = Math.random() * 0.4 + 0.4; // 0.4-0.8 for more expressive style
                    const speaking_rate = Math.random() * 0.3 + 0.8; // Varied speaking rate (0.8-1.1)

                    // Use cache if available
                    const cacheKey = `${text}_${stability.toFixed(2)}_${similarity_boost.toFixed(2)}_${style.toFixed(2)}_${speaking_rate.toFixed(2)}`;

                    let audioPath;
                    if (audioCache.has(cacheKey)) {
                        audioPath = audioCache.get(cacheKey);
                    } else {
                        const response = await fetch(
                            "/api/elevenlabs/text-to-speech",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    text: text,
                                    voice_id: "Q5lUbL40rnWTcPncLVzc", // The requested voice ID
                                    model_id: "eleven_monolingual_v1",
                                    voice_settings: {
                                        stability: stability,
                                        similarity_boost: similarity_boost,
                                        style: style,
                                        use_speaker_boost: true,
                                        speaking_rate: speaking_rate,
                                    },
                                }),
                            },
                        );

                        const data = await response.json();
                        if (!data.success || !data.audioPath) {
                            throw new Error("Failed to generate audio");
                        }

                        audioPath = data.audioPath;
                        audioCache.set(cacheKey, audioPath);
                    }

                    const audio = new Audio(audioPath);

                    // Varied volume for more realistic effect
                    audio.volume = Math.random() * 0.45 + 0.15; // Volume between 0.15-0.4

                    // Add random stereo effect (left/right) for "crowd" sensation
                    const audioContext = new (window.AudioContext ||
                        window.webkitAudioContext)();
                    const source = audioContext.createMediaElementSource(audio);
                    const stereoPanner = audioContext.createStereoPanner();

                    // Random stereo position to create impression of sounds from various directions
                    stereoPanner.pan.value = Math.random() * 2 - 1; // Value from -1 (left) to 1 (right)

                    source.connect(stereoPanner);
                    stereoPanner.connect(audioContext.destination);

                    // When audio ends, release the slot
                    audio.addEventListener("ended", () => {
                        activeAudioCount--;
                    });

                    // Play the audio
                    await audio.play();
                } catch (error) {
                    console.error("Error playing whisper audio:", error);
                    activeAudioCount--; // Release audio slot on error
                }
            }

            // Show random whispers occasionally - optimized for performance
            function animateWhispers() {
                const whispers = document.querySelectorAll(".whisper");
                let lastWhisperTime = 0;
                let whisperCount = 0;
                const MAX_CONCURRENT_WHISPERS = 2; // Reducing max whispers for optimization
                let whisperIntervalId = null;

                // Clear interval if visitor is inactive to save resources
                let userActive = true;
                let inactivityTimer = null;

                // Check user activity
                function resetInactivityTimer() {
                    userActive = true;
                    clearTimeout(inactivityTimer);

                    // If interval isn't active, recreate it
                    if (!whisperIntervalId) {
                        startWhisperInterval();
                    }

                    // Set timer to detect inactivity
                    inactivityTimer = setTimeout(() => {
                        userActive = false;
                        // Stop whisper interval if user is inactive
                        if (whisperIntervalId) {
                            clearInterval(whisperIntervalId);
                            whisperIntervalId = null;
                        }
                    }, 60000); // 60 seconds inactive
                }

                // Listen for mouse movement to detect activity
                document.addEventListener("mousemove", resetInactivityTimer);
                document.addEventListener("keydown", resetInactivityTimer);
                document.addEventListener("click", resetInactivityTimer);
                document.addEventListener("scroll", resetInactivityTimer);

                // Start by default
                resetInactivityTimer();

                // Function to start the interval
                function startWhisperInterval() {
                    // Ensure no duplicate intervals
                    if (whisperIntervalId) {
                        clearInterval(whisperIntervalId);
                    }

                    whisperIntervalId = setInterval(() => {
                        // Check if user is still active
                        if (!userActive) {
                            clearInterval(whisperIntervalId);
                            whisperIntervalId = null;
                            return;
                        }

                        const now = Date.now();
                        const timeSinceLastWhisper = now - lastWhisperTime;

                        // Reset whisper count if there's been a significant gap
                        if (timeSinceLastWhisper > 3000) {
                            whisperCount = 0;
                        }

                        // Lower probability for whispers to appear (optimization)
                        const shouldShowWhisper = Math.random() < 0.25; // Reduce from 0.3 to 0.25

                        // Show whisper if not exceeding the maximum concurrent limit
                        if (
                            shouldShowWhisper &&
                            whisperCount < MAX_CONCURRENT_WHISPERS
                        ) {
                            // When simultaneous whispers will appear (higher = less frequent)
                            const isMultipleWhispers = Math.random() < 0.15;

                            // Number of whispers to show simultaneously
                            const whispersToShow = isMultipleWhispers
                                ? Math.floor(Math.random() * 2) + 2
                                : 1;

                            // Select different whispers to display
                            const usedIndices = new Set();
                            const usedTexts = new Set();
                            const usedGlitchTexts = new Set();

                            for (
                                let i = 0;
                                i < whispersToShow &&
                                whisperCount < MAX_CONCURRENT_WHISPERS;
                                i++
                            ) {
                                // Choose whisper element that hasn't been used yet
                                let randomIndex;
                                do {
                                    randomIndex = Math.floor(
                                        Math.random() * whispers.length,
                                    );
                                } while (usedIndices.has(randomIndex));
                                usedIndices.add(randomIndex);

                                const whisper = whispers[randomIndex];

                                // Determine if this will be a glitch text (20-30% chance)
                                const isGlitch =
                                    Math.random() < Math.random() * 0.1 + 0.2;

                                // Reset class
                                whisper.className = "whisper";
                                if (isGlitch) {
                                    whisper.classList.add("glitch");
                                }

                                let whisperText;

                                if (isGlitch) {
                                    // Choose an unused glitch text
                                    do {
                                        whisperText =
                                            glitchWhisperTexts[
                                                Math.floor(
                                                    Math.random() *
                                                        glitchWhisperTexts.length,
                                                )
                                            ];
                                    } while (usedGlitchTexts.has(whisperText));
                                    usedGlitchTexts.add(whisperText);
                                } else {
                                    // Choose an unused normal whisper text
                                    do {
                                        whisperText =
                                            whisperTexts[
                                                Math.floor(
                                                    Math.random() *
                                                        whisperTexts.length,
                                                )
                                            ];
                                    } while (usedTexts.has(whisperText));
                                    usedTexts.add(whisperText);
                                }

                                whisper.textContent = whisperText;

                                // Glitch text appears with slightly higher opacity
                                whisper.style.opacity = isGlitch
                                    ? Math.random() * 0.3 + 0.1
                                    : Math.random() * 0.1 + 0.05;

                                // Random position
                                const randomX = Math.random() * 100;
                                const randomY = Math.random() * 100;
                                whisper.style.left = `${randomX}%`;
                                whisper.style.top = `${randomY}%`;
                                whisper.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;

                                // Only play audio for normal text, not for glitch text
                                if (!isGlitch) {
                                    // Play audio for normal whispers with a slight delay to avoid playing at exactly the same time
                                    setTimeout(
                                        () => {
                                            playWhisperAudio(whisperText);
                                        },
                                        i * (Math.random() * 300 + 50),
                                    ); // 50-350ms delay between sounds
                                }

                                // Hide after a while
                                // Glitch text lasts shorter
                                const displayDuration = isGlitch
                                    ? Math.random() * 1500 + 1000
                                    : Math.random() * 3000 + 2000;

                                setTimeout(() => {
                                    whisper.style.opacity = 0;
                                    whisperCount--;
                                }, displayDuration);

                                whisperCount++;
                            }

                            lastWhisperTime = now;
                        }
                    }, 700); // Slightly longer interval to be less frequent
                } // End of function startWhisperInterval
            }

            // Create white flashes
            function createFlashes() {
                const flash = document.getElementById("flash");
                const flashText = document.getElementById("flashText");

                // Create short flashes
                function createShortFlash() {
                    // Randomize flash timing
                    const flashDelay = Math.random() * 15000 + 5000; // 5-20 seconds between flashes

                    setTimeout(() => {
                        // Random flash duration
                        const duration = Math.random() * 200 + 50; // 50-250ms

                        // Flash settings
                        const flashIntensity = Math.random() * 0.5 + 0.2; // Vary opacity for different intensities
                        flash.style.opacity = flashIntensity;

                        // Show escape button with low opacity during light flashes
                        const wakeUpBtn = document.getElementById("wakeUpBtn");

                        // Escape button opacity during light flashes (10-20% of flash intensity)
                        const buttonOpacity =
                            flashIntensity * (Math.random() * 0.1 + 0.1);
                        wakeUpBtn.style.opacity = buttonOpacity;

                        // Sometimes show text with the flash
                        if (Math.random() < 0.4) {
                            // Random message
                            const messageIndex = Math.floor(
                                Math.random() * flashMessages.length,
                            );
                            const message = flashMessages[messageIndex];
                            flashText.textContent = message;
                            flashText.style.opacity = 1;
                            flashText.style.animation = `textDistort ${Math.random() * 0.5 + 0.2}s ease-in-out`;

                            // Make escape button clearer during flash messages
                            // For flashes with messages, make button much more visible (40-60% of flash intensity)
                            const enhancedButtonOpacity =
                                flashIntensity * (Math.random() * 0.2 + 0.4);
                            wakeUpBtn.style.opacity = enhancedButtonOpacity;

                            // Add thin white border for button when flash message appears
                            wakeUpBtn.style.borderColor = `rgba(255, 255, 255, ${enhancedButtonOpacity + 0.1})`;
                            wakeUpBtn.style.boxShadow = `0 0 8px rgba(255, 255, 255, ${enhancedButtonOpacity * 0.8})`;

                            // Hide text after flash
                            setTimeout(() => {
                                flashText.style.opacity = 0;
                                // Hide button again after message
                                wakeUpBtn.style.opacity = 0;
                                wakeUpBtn.style.borderColor =
                                    "rgba(255, 255, 255, 0)";
                                wakeUpBtn.style.boxShadow = "none";
                            }, duration + 50);
                        }

                        // Hide flash after duration
                        setTimeout(() => {
                            flash.style.opacity = 0;
                            // Hide escape button again
                            wakeUpBtn.style.opacity = 0;
                            // Schedule next flash
                            createShortFlash();
                        }, duration);
                    }, flashDelay);
                }

                // Create dramatic sequence of multiple flashes
                function createFlashSequence() {
                    // Longer delay between sequences
                    const sequenceDelay = Math.random() * 30000 + 20000; // 20-50 seconds between sequences

                    setTimeout(() => {
                        const flashCount = Math.floor(Math.random() * 3) + 2; // 2-4 flashes in sequence

                        // Show flash message with sequence
                        const messageIndex = Math.floor(
                            Math.random() * flashMessages.length,
                        );
                        const message = flashMessages[messageIndex];
                        flashText.textContent = message;

                        // Get the escape button
                        const wakeUpBtn = document.getElementById("wakeUpBtn");

                        // Create multiple flashes in sequence
                        for (let i = 0; i < flashCount; i++) {
                            setTimeout(
                                () => {
                                    // Higher intensity for sequences
                                    const flashIntensity =
                                        Math.random() * 0.7 + 0.3;
                                    flash.style.opacity = flashIntensity;
                                    flashText.style.opacity =
                                        0.8 + Math.random() * 0.2;

                                    // Show escape button during flash sequences with much higher opacity
                                    // For flash sequences, make button very visible (40-70% of flash intensity)
                                    const buttonOpacity =
                                        flashIntensity *
                                        (Math.random() * 0.3 + 0.4);
                                    wakeUpBtn.style.opacity = buttonOpacity;

                                    // Add stronger glow effect for button during sequences
                                    wakeUpBtn.style.borderColor = `rgba(255, 255, 255, ${buttonOpacity + 0.2})`;
                                    wakeUpBtn.style.boxShadow = `0 0 12px rgba(255, 255, 255, ${buttonOpacity * 0.9})`;

                                    // Make text color clearer during sequences
                                    wakeUpBtn.style.color = `rgba(255, 255, 255, ${buttonOpacity + 0.3})`;

                                    // Flicker effect
                                    setTimeout(
                                        () => {
                                            flash.style.opacity = 0;

                                            // Hide button again
                                            wakeUpBtn.style.opacity = 0;

                                            if (i === flashCount - 1) {
                                                // Last flash in sequence, hide text
                                                setTimeout(() => {
                                                    flashText.style.opacity = 0;
                                                }, 200);
                                            }
                                        },
                                        100 + Math.random() * 150,
                                    );
                                },
                                i * (Math.random() * 200 + 200),
                            ); // 200-400ms between flashes in a sequence
                        }

                        // Schedule next sequence
                        createFlashSequence();
                    }, sequenceDelay);
                }

                // Start both types of flashes
                createShortFlash();
                createFlashSequence();
            }

            // Wake up button functionality
            function setupWakeUpButton() {
                const wakeUpBtn = document.getElementById("wakeUpBtn");

                // Function to randomize button position
                function randomizeButtonPosition() {
                    // Get window browser dimensions
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;

                    // Set minimum margin from screen edge (in pixels)
                    const margin = 20;

                    // Generate random position within browser window considering margin
                    const newX =
                        margin + Math.random() * (viewportWidth - margin * 2);
                    const newY =
                        margin + Math.random() * (viewportHeight - margin * 2);

                    // Reset transform property to remove translateX(-50%) effect
                    wakeUpBtn.style.transition = "all 0.3s ease";
                    wakeUpBtn.style.left = `${newX}px`;
                    wakeUpBtn.style.top = `${newY}px`;
                    wakeUpBtn.style.bottom = "auto";
                    wakeUpBtn.style.transform = "none";
                }

                // Change button position every 5 seconds
                randomizeButtonPosition(); // Initial random position
                const positionInterval = setInterval(
                    randomizeButtonPosition,
                    5000,
                );

                wakeUpBtn.addEventListener("click", function () {
                    // Stop position change interval
                    clearInterval(positionInterval);

                    // Set cookie to indicate user has escaped
                    setCookie("nightmareEscaped", "true", 1); // 1 day

                    // Remove trapped cookie
                    deleteCookie("nightmareTrapped");

                    // Flash before exiting
                    const flash = document.getElementById("flash");
                    flash.style.opacity = 1;

                    // Fade out after a delay
                    setTimeout(function () {
                        document.body.style.transition = "opacity 2s ease-out";
                        document.body.style.opacity = "0";

                        // Redirect back to main page
                        setTimeout(function () {
                            window.location.href = "/";
                        }, 2000);
                    }, 300);
                });
            }

            // Function to initialize and control background music
            function setupBackgroundMusic() {
                const backgroundMusic =
                    document.getElementById("backgroundMusic");
                const pinkNoiseAudio =
                    document.getElementById("pinkNoiseAudio");
                const musicControlBtn =
                    document.getElementById("musicControlBtn");
                let isMusicPlaying = false;

                // Set music volume very low - lower than whisperTexts
                backgroundMusic.volume = 0.15; // Much lower than whisper volume (0.15-0.4)
                pinkNoiseAudio.volume = 0.005; // Pink noise quieter than music box

                // Make sure all audio loops
                backgroundMusic.loop = true;
                pinkNoiseAudio.loop = true;

                // Add event listener to control all music
                musicControlBtn.addEventListener("click", function () {
                    if (isMusicPlaying) {
                        backgroundMusic.pause();
                        pinkNoiseAudio.pause();
                        musicControlBtn.textContent = "Music: Off";
                        isMusicPlaying = false;
                    } else {
                        backgroundMusic.play();
                        pinkNoiseAudio.play();
                        musicControlBtn.textContent = "Music: On";
                        isMusicPlaying = true;
                    }
                });

                // Auto-play music after a few seconds
                setTimeout(() => {
                    // Start music box
                    backgroundMusic
                        .play()
                        .then(() => {
                            isMusicPlaying = true;
                            // After music box successfully plays, start pink noise
                            return pinkNoiseAudio.play();
                        })
                        .catch((error) => {
                            console.error("Music couldn't auto-play:", error);
                            // We won't make the music control button visible even if autoplay fails
                            // Force user to hear music when they interact with the page
                            document.addEventListener('click', function musicClickHandler() {
                                backgroundMusic.play()
                                    .then(() => {
                                        isMusicPlaying = true;
                                        pinkNoiseAudio.play();
                                        // Remove this listener after successfully playing
                                        document.removeEventListener('click', musicClickHandler);
                                    })
                                    .catch((err) => console.error("Still can't play music:", err));
                            });
                        });
                }, 1500);
            }

            // Page performance optimizations
            function optimizePerformance() {
                // Limit frame rate for animations to reduce CPU usage
                let lastFrameTime = 0;
                const targetFPS = 30; // Lower FPS target for better performance
                const frameInterval = 1000 / targetFPS;

                // Replace requestAnimationFrame with throttled version
                const originalRAF = window.requestAnimationFrame;
                window.requestAnimationFrame = function (callback) {
                    const currentTime = performance.now();
                    const timeUntilNextFrame = Math.max(
                        0,
                        frameInterval - (currentTime - lastFrameTime),
                    );

                    setTimeout(() => {
                        lastFrameTime = performance.now();
                        callback(lastFrameTime);
                    }, timeUntilNextFrame);
                };

                // Clean up unused resources periodically
                setInterval(() => {
                    // Limit audio cache size
                    if (audioCache.size > 30) {
                        // Keep only the 20 most recent entries
                        const entries = Array.from(audioCache.entries());
                        const entriesToRemove = entries.slice(
                            0,
                            entries.length - 20,
                        );
                        entriesToRemove.forEach(([key]) =>
                            audioCache.delete(key),
                        );
                    }
                }, 60000); // Check every minute
            }

            // Prevent all navigation if trapped
            function blockAllNavigation() {
                // If user has escaped, don't block navigation
                if (getCookie("nightmareEscaped") === "true") {
                    return;
                }

                // Override all link clicks
                document.addEventListener("click", function (e) {
                    // Check if it's a link click
                    const target = e.target;
                    const linkElement =
                        target instanceof Element ? target.closest("a") : null;

                    if (linkElement) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Create scary whisper when trying to click links
                        const randomIndex = Math.floor(
                            Math.random() * glitchWhisperTexts.length,
                        );
                        const whisper = document.createElement("div");
                        whisper.className = "whisper glitch";
                        whisper.style.left = e.clientX + "px";
                        whisper.style.top = e.clientY + "px";
                        whisper.style.opacity = "0.8";
                        whisper.textContent = glitchWhisperTexts[randomIndex];

                        document
                            .getElementById("whispers")
                            .appendChild(whisper);

                        // Flash the screen red
                        const flash = document.getElementById("flash");
                        flash.style.backgroundColor = "rgba(255, 0, 0, 0.3)";
                        flash.style.opacity = "1";

                        setTimeout(() => {
                            flash.style.opacity = "0";
                            flash.style.backgroundColor = "white";

                            setTimeout(() => {
                                whisper.style.opacity = "0";
                                setTimeout(() => whisper.remove(), 500);
                            }, 1000);
                        }, 100);

                        return false;
                    }
                });

                // Block F5, Ctrl+R, and browser refresh
                window.addEventListener("keydown", function (e) {
                    // Block F5 and Ctrl+R
                    if (e.key === "F5" || (e.ctrlKey && e.key === "r")) {
                        e.preventDefault();
                        showNightmareWhisper("you can't refresh...");
                        return false;
                    }

                    // Block Alt+Left Arrow (browser back)
                    if (e.altKey && e.key === "ArrowLeft") {
                        e.preventDefault();
                        showNightmareWhisper("there is no going back...");
                        return false;
                    }
                });

                // Handle beforeunload (closing tab or window)
                window.addEventListener("beforeunload", function (e) {
                    // Display confirmation message
                    const message =
                        "Are you sure you want to leave? You'll remain trapped in the nightmare...";
                    e.returnValue = message;
                    return message;
                });
            }

            // Initialize everything
            window.onload = function () {
                // Apply performance optimizations
                optimizePerformance();

                // Start all effects
                createWhispers();
                animateWhispers();
                createFlashes();
                setupWakeUpButton();
                setupBackgroundMusic();

                // Block all navigation attempts if trapped
                blockAllNavigation();

                // Subtle breathing animation for the entire page
                document.body.style.animation =
                    "breathe 10s infinite ease-in-out";
            };
        </script>
    </body>
</html>
